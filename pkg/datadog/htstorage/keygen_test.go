package htstorage

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestMemcacheKeygen_HostKey(t *testing.T) {
	kg := MemcacheKeygen{}
	for _, tc := range []struct {
		name        string
		orgID       string
		hostName    string
		expectedKey string
	}{
		{
			name: "happy case",
			// $ echo -n foo | base64
			// Zm9v
			orgID: "foo",
			// $ echo -n bar | base64
			// YmFy
			hostName:    "bar",
			expectedKey: "ht:0:Zm9v:YmFy",
		},
		{
			name: "too long hostname",
			// echo -n foo | sha256sum
			// 2c26b46b68ffc68ff99b453c1d30413413422d706483bfa0f98a5e886266e7ae  -
			orgID:    "foo",
			hostName: "host1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
			// $ echo -n host1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890 | sha256sum
			// 29b53c104b7198c41ca22bd4eda00eca4ea3bdc3277e4a3dbd45a4a33e502deb  -
			expectedKey: "ht:1:2c26b46b68ffc68ff99b453c1d30413413422d706483bfa0f98a5e886266e7ae:29b53c104b7198c41ca22bd4eda00eca4ea3bdc3277e4a3dbd45a4a33e502deb",
		},
		{
			name: "too long orgID",
			// $ echo -n org1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890 | sha256sum
			// dc3c4643ef1e6e07d359b1cff404a3f4d025497b34db8230fcac8b8aefc9eb2c  -
			orgID:    "org1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
			hostName: "host",
			// $ echo -n host | sha256sum
			// 4740ae6347b0172c01254ff55bae5aff5199f4446e7f6d643d40185b3f475145  -
			expectedKey: "ht:1:dc3c4643ef1e6e07d359b1cff404a3f4d025497b34db8230fcac8b8aefc9eb2c:4740ae6347b0172c01254ff55bae5aff5199f4446e7f6d643d40185b3f475145",
		},
	} {
		t.Run(tc.name, func(t *testing.T) {
			key := kg.HostKey(tc.orgID, tc.hostName)
			assert.Equal(t, tc.expectedKey, key)
		})
	}
}
